{{- if .Values.nifi.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nifi-platform.fullname" . }}-nifi-config
  labels:
    {{- include "nifi-platform.nifi.labels" . | nindent 4 }}
data:
  nifi.properties: |
    # Core Properties
    nifi.state.management.embedded.zookeeper.start=false
    nifi.flow.configuration.file=/opt/nifi/nifi-current/conf/flow.xml.gz
    nifi.flow.configuration.archive.dir=/opt/nifi/nifi-current/conf/archive/
    nifi.flow.configuration.archive.enabled=true
    nifi.flow.configuration.archive.max.time=30 days
    nifi.flow.configuration.archive.max.storage=500 MB
    nifi.flowcontroller.autoResumeState=true
    nifi.flowcontroller.graceful.shutdown.period=10 sec
    nifi.flowservice.writedelay.interval=500 ms
    nifi.content.repository.implementation=org.apache.nifi.controller.repository.FileSystemRepository
    nifi.content.repository.directory.default=/opt/nifi/nifi-current/content_repository
    nifi.content.repository.archive.max.retention.period=30 days
    nifi.content.repository.archive.max.usage.percentage=50%
    nifi.content.repository.archive.enabled=true
    nifi.content.repository.threads=8
    nifi.flowfile.repository.implementation=org.apache.nifi.controller.repository.WriteAheadFlowFileRepository
    nifi.flowfile.repository.directory=/opt/nifi/nifi-current/flowfile_repository
    nifi.flowfile.repository.partitions=256
    nifi.flowfile.repository.checkpoint.interval=2 mins
    nifi.flowfile.repository.always.sync=false
    nifi.provenance.repository.implementation=org.apache.nifi.provenance.WriteAheadProvenanceRepository
    nifi.provenance.repository.directory.default=/opt/nifi/nifi-current/provenance_repository
    nifi.provenance.repository.max.storage.time={{ .Values.nifi.properties.nifi.provenance.repository.max.storage.time }}
    nifi.provenance.repository.max.storage.size={{ .Values.nifi.properties.nifi.provenance.repository.max.storage.size }}
    nifi.provenance.repository.rollover.size=100 MB
    nifi.provenance.repository.rollover.time=1 min
    nifi.provenance.repository.query.threads=2
    nifi.provenance.repository.index.threads=2
    nifi.provenance.repository.compress.on.rollover=true
    nifi.components.status.repository.buffer.size=1440
    nifi.components.status.snapshot.frequency=1 min
    # Sensitive Properties Key (required for NiFi to start)
    nifi.sensitive.props.key=changeme-please-change-in-production
    nifi.sensitive.props.algorithm=NIFI_PBKDF2_AES_GCM_256
    # NAR Library Directory (required for NiFi to start)
    nifi.nar.library.directory=/opt/nifi/nifi-current/lib
    nifi.nar.library.autoload.directory=/opt/nifi/nifi-current/extensions
    nifi.nar.working.directory=/opt/nifi/nifi-current/work/nar
    # Database Directory (required for audit database)
    nifi.database.directory=/opt/nifi/nifi-current/database
    # Security
    {{- if .Values.nifi.security.ssl.enabled }}
    nifi.security.keystore=/opt/nifi/nifi-current/conf/keystore.p12
    nifi.security.keystoreType=PKCS12
    nifi.security.keystorePasswd=
    nifi.security.keyPasswd=
    nifi.security.truststore=/opt/nifi/nifi-current/conf/truststore.p12
    nifi.security.truststoreType=PKCS12
    nifi.security.truststorePasswd=
    nifi.security.needClientAuth=true
    {{- end }}
    {{- if .Values.nifi.security.enabled }}
    nifi.security.user.authorizer=managed-authorizer
    nifi.security.user.login.identity.provider={{ if .Values.nifi.keycloak.enabled }}keycloak-provider{{ else }}single-user-provider{{ end }}
    nifi.security.allow.anonymous.authentication=false
    {{- else }}
    nifi.security.user.authorizer=file-provider
    nifi.security.user.login.identity.provider=single-user-provider
    nifi.security.allow.anonymous.authentication=true
    {{- end }}
    {{- if .Values.nifi.keycloak.enabled }}
    nifi.security.user.oidc.discovery.url={{ .Values.nifi.keycloak.url }}/realms/{{ .Values.nifi.keycloak.realm }}
    nifi.security.user.oidc.client.id={{ .Values.nifi.keycloak.clientId }}
    nifi.security.user.oidc.client.secret={{ .Values.nifi.keycloak.clientSecret }}
    nifi.security.user.oidc.scope={{ .Values.nifi.properties.nifi.security.user.oidc.scope }}
    nifi.security.user.oidc.claim.identifying.user={{ .Values.nifi.properties.nifi.security.user.oidc.claim.identifying.user }}
    nifi.security.user.oidc.fallback.claims.identifying.user={{ .Values.nifi.properties.nifi.security.user.oidc.fallback.claims.identifying.user }}
    {{- end }}
    # Web Properties
    nifi.web.http.port={{ .Values.nifi.properties.nifi.web.http.port }}
    nifi.web.https.port.forwarding={{ .Values.nifi.properties.nifi.web.https.port }}
    # nifi.web.http.host will be set dynamically by initContainer to pod IP address
    {{- if .Values.nifi.security.ssl.enabled }}
    nifi.web.https.host={{ .Values.nifi.properties.nifi.web.https.host }}
    {{- end }}
    # Cluster Properties
    nifi.cluster.is.node={{ .Values.nifi.properties.nifi.cluster.is.node }}
    # Cluster node address will be set dynamically by initContainer for each pod
    # Format: <pod-name>.<headless-service>.<namespace>.svc.cluster.local
    # Example: nifi-platform-nifi-0.nifi-platform-nifi-headless.data-platform-integration.svc.cluster.local
    # The initContainer replaces this with the actual pod FQDN
    nifi.cluster.node.address={{ include "nifi-platform.fullname" . }}-nifi-0.{{ include "nifi-platform.fullname" . }}-nifi-headless.{{ .Values.global.namespace | default .Release.Namespace }}.svc.cluster.local
    nifi.cluster.node.protocol.port={{ .Values.nifi.properties.nifi.cluster.node.protocol.port }}
    nifi.cluster.node.connection.timeout={{ .Values.nifi.properties.nifi.cluster.node.connection.timeout }}
    nifi.cluster.node.read.timeout={{ .Values.nifi.properties.nifi.cluster.node.read.timeout }}
    nifi.cluster.node.max.concurrent.requests={{ .Values.nifi.properties.nifi.cluster.node.max.concurrent.requests }}
    nifi.cluster.flow.election.max.wait.time={{ .Values.nifi.properties.nifi.cluster.flow.election.max.wait.time }}
    nifi.cluster.flow.election.max.candidates={{ .Values.nifi.properties.nifi.cluster.flow.election.max.candidates }}
    nifi.cluster.protocol.is.secure=false
    # Web Proxy Host
    nifi.web.proxy.host=0.0.0.0
    # ZooKeeper Properties
    nifi.zookeeper.connect.string={{ include "nifi-platform.zookeeper.connectionString" . }}
    nifi.zookeeper.connect.timeout=10 secs
    nifi.zookeeper.session.timeout=10 secs
    nifi.zookeeper.root.node=/nifi
    # State Management
    nifi.state.management.config.file=/opt/nifi/nifi-current/conf/state-management.xml
    nifi.state.management.provider.cluster={{ .Values.nifi.properties.nifi.state.management.provider.cluster }}
    nifi.state.management.provider.local=local-provider
    nifi.state.management.provider.local.class=org.apache.nifi.controller.state.providers.local.WriteAheadLocalStateProvider
    nifi.state.management.provider.local.directory=/opt/nifi/nifi-current/state/local
    # Site to Site
    nifi.remote.input.secure=false
    nifi.remote.input.socket.port={{ .Values.nifi.properties.nifi.remote.input.socket.port }}
    nifi.remote.input.socket.host={{ include "nifi-platform.fullname" . }}-nifi
    nifi.remote.input.http.enabled=true
    nifi.remote.input.http.transaction.ttl=30 sec
    nifi.remote.contents.cache.expiration=30 secs
    nifi.remote.processor.threads=10
    # Remote input host will be set dynamically by entrypoint script
    # Format: <pod-name>.<headless-service>.<namespace>.svc.cluster.local
    nifi.remote.input.host={{ include "nifi-platform.fullname" . }}-nifi
    nifi.remote.input.port=8082
    nifi.remote.command.response.port=8082
    nifi.remote.command.port=8082
    nifi.remote.command.http.enabled=true
    nifi.remote.command.http.transaction.ttl=30 sec
    nifi.remote.command.threads=10
    nifi.remote.command.max.concurrent.requests=100
    nifi.remote.command.need.response=true
    nifi.remote.command.response.timeout=30 secs
    nifi.remote.command.require.secure=true
{{- end }}

